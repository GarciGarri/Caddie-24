generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// AUTH & TEAM
// ============================================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  hashedPassword String
  role           UserRole  @default(AGENT)
  avatarUrl      String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  assignedConversations Conversation[] @relation("AssignedAgent")
  internalNotes         InternalNote[]
  campaignsCreated      Campaign[]     @relation("CampaignCreator")
  sessions              Session[]
  accounts              Account[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// PLAYER PROFILES (Core CRM)
// ============================================================

model Player {
  id                  String          @id @default(cuid())
  firstName           String
  lastName            String
  email               String?         @unique
  phone               String          @unique
  whatsappId          String?         @unique
  handicap            Float?
  birthday            DateTime?
  preferredLanguage   Language        @default(ES)
  avatarUrl           String?
  notes               String?         @db.Text

  preferredPlayTime   PlayTimeSlot?
  playDayPreference   DayPreference?
  playStylePreference PlayStyle?
  engagementLevel     EngagementLevel @default(NEW)

  source              String?
  isActive            Boolean         @default(true)
  lastContactAt       DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  visits              Visit[]
  consumptions        Consumption[]
  tags                PlayerTag[]
  conversations       Conversation[]
  campaignRecipients  CampaignRecipient[]
  engagementEvents    EngagementEvent[]

  @@index([phone])
  @@index([whatsappId])
  @@index([lastName, firstName])
  @@index([engagementLevel])
  @@map("players")
}

enum Language {
  ES
  EN
  DE
  FR
}

enum PlayTimeSlot {
  EARLY_MORNING
  MORNING
  AFTERNOON
  EVENING
}

enum DayPreference {
  WEEKDAY
  WEEKEND
  BOTH
}

enum PlayStyle {
  SOLO
  DUO
  GROUP
}

enum EngagementLevel {
  NEW
  LOW
  MEDIUM
  HIGH
  VIP
}

model Visit {
  id         String   @id @default(cuid())
  playerId   String
  date       DateTime
  courseType  String?
  companions String[]
  duration   Int?
  notes      String?
  createdAt  DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId, date])
  @@map("visits")
}

model Consumption {
  id          String              @id @default(cuid())
  playerId    String
  date        DateTime
  category    ConsumptionCategory
  description String
  amount      Decimal             @db.Decimal(10, 2)
  currency    String              @default("EUR")
  createdAt   DateTime            @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId, date])
  @@index([category])
  @@map("consumptions")
}

enum ConsumptionCategory {
  GREEN_FEE
  SUBSCRIPTION
  CLASS
  RESTAURANT
  SHOP
  RENTAL
  EVENT
  OTHER
}

model PlayerTag {
  id         String    @id @default(cuid())
  playerId   String
  tag        String
  source     TagSource @default(AI)
  confidence Float?
  createdAt  DateTime  @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, tag])
  @@index([tag])
  @@map("player_tags")
}

enum TagSource {
  AI
  MANUAL
}

model EngagementEvent {
  id        String         @id @default(cuid())
  playerId  String
  type      EngagementType
  metadata  Json?
  createdAt DateTime       @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId, createdAt])
  @@map("engagement_events")
}

enum EngagementType {
  MESSAGE_SENT
  MESSAGE_DELIVERED
  MESSAGE_READ
  MESSAGE_REPLIED
  LINK_CLICKED
  CAMPAIGN_OPENED
}

// ============================================================
// WHATSAPP CONVERSATIONS & MESSAGES
// ============================================================

model Conversation {
  id                 String             @id @default(cuid())
  playerId           String
  assignedToId       String?
  status             ConversationStatus @default(OPEN)
  channel            String             @default("whatsapp")
  lastMessageAt      DateTime?
  lastMessagePreview String?            @db.VarChar(255)
  unreadCount        Int                @default(0)
  isAiBotActive      Boolean            @default(true)
  metadata           Json?

  currentSentiment   Sentiment?
  currentIntent      String?
  aiSummary          String?            @db.Text

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  player             Player             @relation(fields: [playerId], references: [id], onDelete: Cascade)
  assignedTo         User?              @relation("AssignedAgent", fields: [assignedToId], references: [id])
  messages           Message[]
  internalNotes      InternalNote[]

  @@index([playerId])
  @@index([assignedToId])
  @@index([status, lastMessageAt])
  @@map("conversations")
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
  FRUSTRATED
}

model Message {
  id                String           @id @default(cuid())
  conversationId    String
  whatsappMessageId String?          @unique
  direction         MessageDirection
  type              MessageType      @default(TEXT)
  content           String           @db.Text
  mediaUrl          String?
  mediaMimeType     String?
  templateName      String?
  status            MessageStatus    @default(SENT)
  sentBy            String?
  isAiGenerated     Boolean          @default(false)
  aiDraft           String?          @db.Text

  sentiment         Sentiment?
  intent            String?
  language          Language?

  timestamp         DateTime         @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?

  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, timestamp])
  @@index([whatsappMessageId])
  @@map("messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  LOCATION
  TEMPLATE
  INTERACTIVE
  REACTION
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model InternalNote {
  id             String   @id @default(cuid())
  conversationId String
  authorId       String
  content        String   @db.Text
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author       User         @relation(fields: [authorId], references: [id])

  @@index([conversationId, createdAt])
  @@map("internal_notes")
}

// ============================================================
// CAMPAIGNS & TEMPLATES
// ============================================================

model Campaign {
  id              String         @id @default(cuid())
  name            String
  description     String?        @db.Text
  status          CampaignStatus @default(DRAFT)
  createdById     String
  templateName    String
  segmentQuery    Json
  scheduledAt     DateTime?
  sentAt          DateTime?
  completedAt     DateTime?

  isAbTest        Boolean        @default(false)
  variantA        Json?
  variantB        Json?
  abWinnerVariant String?
  abAnalysis      String?        @db.Text

  totalRecipients Int            @default(0)
  totalSent       Int            @default(0)
  totalDelivered  Int            @default(0)
  totalRead       Int            @default(0)
  totalReplied    Int            @default(0)
  totalFailed     Int            @default(0)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  createdBy       User           @relation("CampaignCreator", fields: [createdById], references: [id])
  recipients      CampaignRecipient[]

  @@index([status])
  @@index([scheduledAt])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  ANALYZING
  COMPLETED
  CANCELLED
}

model CampaignRecipient {
  id              String        @id @default(cuid())
  campaignId      String
  playerId        String
  variant         String?
  status          MessageStatus @default(PENDING)
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  repliedAt       DateTime?
  failureReason   String?
  optimalSendTime DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([campaignId, playerId])
  @@index([campaignId, status])
  @@map("campaign_recipients")
}

model WhatsAppTemplate {
  id              String         @id @default(cuid())
  name            String         @unique
  language        Language
  category        String
  status          TemplateStatus @default(PENDING)
  components      Json
  metaTemplateId  String?
  rejectionReason String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("whatsapp_templates")
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================
// SETTINGS & CONFIGURATION
// ============================================================

model ClubSettings {
  id                        String          @id @default("default")
  clubName                  String
  timezone                  String          @default("Europe/Madrid")
  defaultLanguage           Language        @default(ES)
  currency                  String          @default("EUR")

  whatsappPhoneNumberId     String?
  whatsappBusinessAccountId String?
  whatsappAccessToken       String?         @db.Text
  webhookVerifyToken        String?

  voiceTone                 String?         @db.Text
  voiceValues               String?         @db.Text
  voiceStyle                String?         @db.Text
  voiceExamples             Json?

  silenceHoursStart         String?         @default("22:00")
  silenceHoursEnd           String?         @default("08:00")
  silenceDays               String[]        @default([])

  automationLevel           AutomationLevel @default(ASSISTED)
  escalationSentimentThreshold Float        @default(0.3)
  escalationKeywords        String[]        @default([])
  maxAutoReplies            Int             @default(5)

  bookingConflictHours      Int             @default(24)

  updatedAt                 DateTime        @updatedAt

  @@map("club_settings")
}

enum AutomationLevel {
  MANUAL
  ASSISTED
  SEMI_AUTO
  FULL_AUTO
}

// ============================================================
// AI ANALYSIS LOG
// ============================================================

model AiAnalysisLog {
  id             String         @id @default(cuid())
  type           AiAnalysisType
  inputTokens    Int
  outputTokens   Int
  model          String
  durationMs     Int
  playerId       String?
  conversationId String?
  result         Json
  createdAt      DateTime       @default(now())

  @@index([type, createdAt])
  @@index([playerId])
  @@map("ai_analysis_logs")
}

enum AiAnalysisType {
  DRAFT_GENERATION
  SENTIMENT_ANALYSIS
  INTENT_DETECTION
  CONVERSATION_SUMMARY
  TAG_GENERATION
  TRANSLATION
  OPTIMAL_TIME
  ESCALATION_CHECK
  AB_ANALYSIS
  CHATBOT_RESPONSE
}
